# Premarket Filtration - Usage Guide

## Overview

The volume SMA filtration has been **decoupled from the strategy engine hot path** for optimal performance. You now run a standalone premarket script before market hours to filter stocks.

## Credentials Setup

The premarket filter needs your Dhan API credentials. You have two options:

### Option 1: Environment Variables (Recommended)

Set environment variables in your terminal:

**Windows (PowerShell):**
```powershell
$env:DHAN_CLIENT_ID="your_client_id"
$env:DHAN_ACCESS_TOKEN="your_access_token"
```

**Windows (Command Prompt):**
```cmd
set DHAN_CLIENT_ID=your_client_id
set DHAN_ACCESS_TOKEN=your_access_token
```

**Linux/Mac:**
```bash
export DHAN_CLIENT_ID="your_client_id"
export DHAN_ACCESS_TOKEN="your_access_token"
```

### Option 2: Interactive Input

Simply run the script and it will prompt you to enter credentials:
```bash
python premarket_filter.py
# You'll be prompted:
# Enter Dhan Client ID: 
# Enter Dhan Access Token: (hidden input)
```

## Workflow

### Step 1: Run Premarket Filtration (Before Market Hours)

```bash
python premarket_filter.py
```

**What it does:**
- Fetches 15 days of historical data for all 180 stocks in `STOCK_LIST`
- Applies volume SMA filter: `(sum of last 5 days volume / 1875) > 2000`
- Saves accepted candidates to `filtered_stocks.json`
- Shows detailed progress and summary
- Saves the same-day results to Redis (so repeated runs can reuse the cache)

**Re-run behavior (same day):**
- By default, the script will **reuse todayâ€™s cached candidates from Redis** if available.
- To **rescreen all stocks** (ignore Redis cache), run:
  ```bash
  python premarket_filter.py --force
  ```

**Rate limiting:**
- Defaults are tuned to be conservative (`--rate 3`, `--connections 5`, `--in-flight 5`).
- If Dhan returns `DH-904 Rate_Limit`, the client will automatically cool down and retry (run time may increase).

**Expected output:**
```
======================================================================
PREMARKET STOCK FILTRATION - Volume SMA Filter
======================================================================
Initializing Dhan client...
Dhan client connected successfully
Starting Volume SMA Filtration on 180 stocks...
Criteria: Volume SMA > 2000
======================================================================
âœ“ ACCEPTED MRF: VolSMA=2666.67, PrevClose=131500.50
âœ“ ACCEPTED BOSCHLTD: VolSMA=2453.33, PrevClose=34250.75
...
======================================================================
Filtration Complete: 45 / 180 stocks accepted
Saved 45 candidates to filtered_stocks.json
======================================================================
SUMMARY
======================================================================
Total stocks screened: 180
Stocks accepted: 45
Acceptance rate: 25.0%

Accepted Stocks:
  ABB: â‚¹6850.25
  BOSCHLTD: â‚¹34250.75
  ...
======================================================================
Filtration complete! You can now start the strategy engine.
```

### Step 2: Start Strategy Engine (Market Hours)

```bash
python main.py
# or
python verify_app.py
```

**What happens:**
- Strategy engine loads pre-filtered candidates from `filtered_stocks.json` **instantly** (no API calls)
- Subscribes WebSocket only to filtered candidates
- Begins real-time trading on eligible stocks

**Benefits:**
- âš¡ **Hot path is now blazing fast** - no historical API calls during startup
- ðŸ“Š Premarket filtration can be run anytime before market hours
- ðŸ”„ Re-run `premarket_filter.py` anytime to refresh candidates
- ðŸ’¾ JSON file contains timestamp and filtration metadata for auditing

## File Structure

```
ladder_Super/
â”œâ”€â”€ premarket_filter.py          # Run this BEFORE market hours
â”œâ”€â”€ filtered_stocks.json          # Generated by premarket_filter.py
â”œâ”€â”€ strategy_engine.py            # Loads from filtered_stocks.json
â””â”€â”€ verify_filter.py              # Test script for validation
```

## JSON Format

`filtered_stocks.json` structure:
```json
{
  "timestamp": "2026-02-03T07:30:00.123456",
  "criteria": {
    "volume_sma_threshold": 2000,
    "volume_sma_divisor": 1875,
    "required_days": 5
  },
  "total_stocks_screened": 180,
  "stocks_accepted": 45,
  "candidates": {
    "MRF": 131500.50,
    "BOSCHLTD": 34250.75,
    ...
  }
}
```

## Error Handling

If you forget to run premarket filtration:
```
ERROR:strategy_engine:Filtered stocks file not found: filtered_stocks.json
ERROR:strategy_engine:Please run 'python premarket_filter.py' before starting the strategy engine
ERROR:strategy_engine:No filtered stocks available. Run premarket_filter.py first!
```

## Testing

Test the JSON loading functionality:
```bash
python verify_filter.py
```

This creates a mock JSON file, tests loading, validates data, and cleans up automatically.

## Performance Impact

**Before (Old Approach):**
- Strategy engine startup: ~30-60 seconds
- 180 stocks Ã— historical API calls = major delay
- Blocking the hot path

**After (New Approach):**
- Premarket filtration: ~30-60 seconds (run once before market)
- Strategy engine startup: ~1-2 seconds (instant JSON load)
- Hot path is completely free of I/O operations âš¡

---

**You're all set! Run `python premarket_filter.py` before market hours, then start your strategy engine for lightning-fast performance.**
